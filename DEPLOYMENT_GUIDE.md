# 🚀 Deployment Guide - Momentum EMR

Complete guide to deploying your EMR system to production.

---

## 📋 Prerequisites

Before deployment, ensure you have:
- ✅ GitHub account with repository access
- ✅ Railway account (or preferred hosting platform)
- ✅ PostgreSQL database (Railway provides this)
- ✅ Domain name (optional)

---

## 🏗️ Option 1: Deploy to Railway (Recommended)

Railway provides easy deployment with PostgreSQL included.

### Step 1: Prepare Your Code

```bash
# Ensure all changes are committed
git add .
git commit -m "Prepare for deployment"
git push origin main
```

### Step 2: Create Railway Project

1. Go to [railway.app](https://railway.app)
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Choose your repository: `Momentum-Health-Care/EMR`
5. Railway will automatically detect Next.js

### Step 3: Add PostgreSQL Database

1. In your Railway project, click "New"
2. Select "Database" → "PostgreSQL"
3. Railway will automatically provision a database
4. Note: `DATABASE_URL` is automatically set

### Step 4: Configure Environment Variables

Go to your project settings → Variables, add:

```env
# Database (auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# NextAuth Configuration
NEXTAUTH_URL=https://your-app.railway.app
NEXTAUTH_SECRET=generate-a-secure-32-char-secret

# Node Environment
NODE_ENV=production

# File Storage (start with local, upgrade to S3 later)
USE_S3=false

# Optional: S3/R2 Configuration (when ready)
# S3_REGION=auto
# S3_ENDPOINT=https://[account-id].r2.cloudflarestorage.com
# S3_ACCESS_KEY_ID=your-key
# S3_SECRET_ACCESS_KEY=your-secret
# S3_BUCKET=emr-files
# S3_PUBLIC_URL=https://your-cdn-domain.com
```

**Generate NEXTAUTH_SECRET:**
```bash
openssl rand -base64 32
```

### Step 5: Run Database Migrations

Railway provides a shell. Run:

```bash
# Access Railway shell
railway shell

# Run migrations
npx prisma migrate deploy

# Seed database
npx prisma db seed
```

### Step 6: Deploy

Railway automatically deploys on every push. Your app will be available at:
```
https://your-app.railway.app
```

### Step 7: Configure Custom Domain (Optional)

1. In Railway project settings → Domains
2. Click "Custom Domain"
3. Add your domain (e.g., `emr.yourhospital.com`)
4. Update DNS records as instructed
5. Update `NEXTAUTH_URL` to your custom domain

---

## 🌐 Option 2: Deploy to Vercel + Supabase

### Step 1: Deploy Frontend to Vercel

1. Go to [vercel.com](https://vercel.com)
2. Import your GitHub repository
3. Configure build settings:
   - Framework: Next.js
   - Root directory: `apps/web`
   - Build command: `pnpm build`
   - Output directory: `.next`

### Step 2: Create Supabase Database

1. Go to [supabase.com](https://supabase.com)
2. Create new project
3. Note your database connection string

### Step 3: Set Environment Variables in Vercel

Add all the environment variables from `.env.example`

### Step 4: Run Migrations

```bash
# Connect to Supabase
export DATABASE_URL="your-supabase-connection-string"

# Run migrations
npx prisma migrate deploy

# Seed database
npx prisma db seed
```

---

## 🔐 Security Checklist

Before going live, ensure:

- [ ] Strong `NEXTAUTH_SECRET` is set
- [ ] Database credentials are secure
- [ ] HTTPS is enabled (Railway/Vercel do this automatically)
- [ ] CORS is properly configured
- [ ] File upload limits are set
- [ ] Rate limiting is considered
- [ ] Error logging is configured

---

## 📦 Post-Deployment Setup

### 1. Test Login

```
URL: https://your-app.railway.app/login
Email: john.admin@citygeneralhospital.com
Password: password123
```

### 2. Change Default Passwords

Immediately change all seed user passwords:
1. Login as admin
2. Go to Users → Edit each user
3. Set strong passwords

### 3. Create Your Hospital

If using the seed data, you have "City General Hospital". 

To add a new hospital (as Momentum admin):
1. Login as momentum.admin@momentum.com
2. Go to Hospitals
3. Add new hospital
4. Create admin user for that hospital

### 4. Configure File Storage (Optional)

#### Using Cloudflare R2:

1. Create Cloudflare account
2. Go to R2 Object Storage
3. Create bucket: `emr-files`
4. Create API token
5. Update environment variables:
   ```env
   USE_S3=true
   S3_REGION=auto
   S3_ENDPOINT=https://[account-id].r2.cloudflarestorage.com
   S3_ACCESS_KEY_ID=your-key
   S3_SECRET_ACCESS_KEY=your-secret
   S3_BUCKET=emr-files
   S3_PUBLIC_URL=https://pub-[id].r2.dev
   ```

6. Restart your application

---

## 🔄 Continuous Deployment

### Automatic Deployment (Railway)

Every push to `main` branch triggers deployment:

```bash
git add .
git commit -m "Feature: Add new functionality"
git push origin main
# Railway automatically deploys
```

### Manual Deployment

```bash
# In Railway dashboard
railway up
```

---

## 📊 Monitoring & Logs

### View Logs (Railway)

1. Go to your project dashboard
2. Click on your service
3. View "Logs" tab
4. Monitor for errors

### View Logs (Vercel)

1. Go to your project
2. Click "Deployments"
3. Select deployment
4. View logs

---

## 🐛 Troubleshooting

### Database Connection Issues

```bash
# Test database connection
railway run npx prisma db pull
```

### Migration Issues

```bash
# Reset database (WARNING: This deletes all data)
railway run npx prisma migrate reset

# Apply migrations
railway run npx prisma migrate deploy
```

### Build Failures

Check:
1. All environment variables are set
2. `package.json` scripts are correct
3. Build logs for specific errors

### File Upload Not Working

Ensure:
1. `uploads` directory exists (for local storage)
2. S3 credentials are correct (for S3 storage)
3. File size limits are appropriate

---

## 📈 Performance Optimization

### Database Indexing

Ensure indexes are created (already in schema):
- Patient search fields
- Appointment dates
- Invoice status
- Inventory expiry dates

### Caching

Consider adding:
- Redis for session storage
- CDN for static assets
- Database query caching

### Monitoring

Add monitoring tools:
- **Sentry**: Error tracking
- **LogRocket**: Session replay
- **New Relic**: Performance monitoring

---

## 🔒 Backup Strategy

### Database Backups

Railway automatic backups:
- Enabled by default
- Configurable retention period
- Manual backups available

### Manual Backup

```bash
# Export database
railway run pg_dump $DATABASE_URL > backup.sql

# Restore database
railway run psql $DATABASE_URL < backup.sql
```

### File Storage Backups

If using S3/R2:
- Versioning enabled by default
- Configure lifecycle rules
- Regular backup to different region

---

## 🚀 Scaling Considerations

### Horizontal Scaling

Railway supports:
- Auto-scaling based on load
- Multiple replicas
- Load balancing

### Database Scaling

- Upgrade PostgreSQL plan
- Enable connection pooling
- Add read replicas

### File Storage Scaling

- S3/R2 scales automatically
- Consider CDN for file delivery
- Implement caching

---

## 📱 Mobile App Deployment (Future)

When deploying mobile apps:

1. **iOS**: App Store
2. **Android**: Google Play Store
3. Update API URLs to production
4. Configure push notifications
5. Test thoroughly before release

---

## ✅ Pre-Launch Checklist

- [ ] All environment variables set
- [ ] Database migrations applied
- [ ] Seed data loaded
- [ ] Default passwords changed
- [ ] HTTPS enabled
- [ ] Custom domain configured
- [ ] Backup strategy in place
- [ ] Monitoring tools configured
- [ ] Error logging enabled
- [ ] Load testing completed
- [ ] Security audit passed
- [ ] User documentation prepared
- [ ] Support system ready

---

## 🎉 You're Live!

Congratulations! Your EMR system is now in production.

### Next Steps:

1. **Onboard Users**: Train staff on the system
2. **Monitor Performance**: Watch logs and metrics
3. **Gather Feedback**: Collect user feedback
4. **Iterate**: Continue improving based on usage
5. **Market**: Promote your EMR system

---

## 📞 Support

For deployment issues:
- Check Railway/Vercel documentation
- Review application logs
- Test locally first
- Ask for help in community forums

---

## 🔄 Updates & Maintenance

### Regular Updates

```bash
# Pull latest changes
git pull origin main

# Railway auto-deploys
# Or manually trigger:
railway up
```

### Maintenance Mode

To enable maintenance mode:
1. Add maintenance page
2. Configure Railway to serve it
3. Notify users in advance

---

**Your EMR system is production-ready! 🎊**

For questions or issues, refer to the documentation or reach out to the development team.
