// Momentum EMR/EHR Database Schema
// Multi-tenant Electronic Medical Records system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// ENUMS
// ===================================

enum UserRole {
  super_admin
  admin
  doctor
  nurse
  pharmacist
  receptionist
  cashier
  patient
  lab_tech
}

enum PatientType {
  hmo
  corporate
  self_pay
}

enum AppointmentType {
  OPD
  IPD
  surgery
  lab
  follow_up
  walk_in
}

enum AppointmentStatus {
  scheduled
  checked_in
  completed
  cancelled
}

enum PrescriptionStatus {
  active
  completed
}

enum InvoiceStatus {
  pending
  paid
  cancelled
  refunded
}

enum NotificationType {
  lab_order
  prescription_issued
  inventory_low
  appointment_reminder
  lab_result_ready
  payment_due
  account
}

enum DeliveryMethod {
  email
  sms
  push
  in_app
}

enum NotificationStatus {
  pending
  sent
  read
  failed
}

enum LabOrderType {
  Lab_Test
  X_ray
  CT_Scan
  MRI
  Ultrasound
  Pathology
}

enum LabOrderStatus {
  pending
  in_progress
  completed
  cancelled
}

enum ClaimStatus {
  draft
  ready_for_claims
  batching
  submitted
  processing
  paid
  partially_paid
  queried
  denied
  disputed
  outstanding
  resubmitted
}

enum ClaimSubmissionMethod {
  email_pdf
  portal_excel
  portal_csv
  api
}

enum HMOCodingStandard {
  icd10
  cpt
  local
}

enum DashboardType {
  patient_volume
  revenue
  drug_statistics
  consultation_metrics
  operational
}

enum ReportType {
  daily_summary
  weekly_revenue
  monthly_patient_volume
  drug_usage
  consultation_times
}

enum ReportStatus {
  generating
  completed
  failed
}

// ===================================
// MODELS
// ===================================

model Hospital {
  id                Int      @id @default(autoincrement())
  name              String
  subdomain         String   @unique
  address           String?  @db.Text
  contactEmail      String?  @map("contact_email")
  phoneNumber       String?  @map("phone_number")
  subscriptionPlan  String?  @map("subscription_plan")
  active            Boolean  @default(true)
  
  // Branding fields
  logoUrl              String?  @map("logo_url")
  primaryColor         String?  @default("#0F4C81") @map("primary_color")
  secondaryColor       String?  @default("#4A90E2") @map("secondary_color")
  tagline              String?
  backgroundImageUrl   String?  @map("background_image_url") // Login page background
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  users                User[]
  patients             Patient[]
  hmo                  Hmo[]
  corporateClients     CorporateClient[]
  appointments         Appointment[]
  medicalRecords       MedicalRecord[]
  prescriptions        Prescription[]
  inventory            Inventory[]
  invoices             Invoice[]
  notifications        Notification[]
  patientSurveys       PatientSurvey[]
  labOrders            LabOrder[]
  surveys              Survey[]
  analyticsDashboards  AnalyticsDashboard[]
  analyticsReports     AnalyticsReport[]
  analyticsMetrics      AnalyticsMetric[]
  encounters            Encounter[] // HMO encounters
  claimBatches          ClaimBatch[] // HMO claim batches
  nursingInventoryUsage NursingInventoryUsage[]
  labInventoryUsage     LabInventoryUsage[]

  @@map("hospitals")
}

model User {
  id                   Int       @id @default(autoincrement())
  hospitalId           Int       @map("hospital_id")
  name                 String
  email                String
  hashedPassword       String    @map("hashed_password")
  role                 UserRole
  active               Boolean   @default(true)
  mustChangePassword   Boolean   @default(false) @map("must_change_password")
  lastLogin            DateTime? @map("last_login")
  passwordResetToken   String?   @map("password_reset_token") @db.Text
  passwordResetExpiry  DateTime? @map("password_reset_expiry")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  hospital                Hospital              @relation(fields: [hospitalId], references: [id])
  patientProfile          Patient?
  assignedPatients        Patient[]             @relation("PrimaryDoctor")
  appointments            Appointment[]
  medicalRecords          MedicalRecord[]
  prescriptions           Prescription[]
  dispensedPrescriptions  Prescription[]        @relation("DispensedBy")
  labOrdersOrdered        LabOrder[]            @relation("OrderedBy")
  labOrdersAssigned       LabOrder[]            @relation("AssignedLabTech")
  labResultsUploaded      LabResult[]           @relation("UploadedBy")
  labResultsReleased      LabResult[]           @relation("ReleasedBy")
  notificationsReceived   Notification[]        @relation("NotificationRecipient")
  notificationsSent       Notification[]        @relation("NotificationSender")
  surveysCreated          Survey[]
  analyticsDashboards     AnalyticsDashboard[]  @relation("DashboardCreator")
  analyticsReports        AnalyticsReport[]     @relation("ReportGenerator")
  vitalsRecorded          Vital[]               @relation("VitalsRecordedBy")
  admissionsAdmitted      Admission[]           @relation("AdmissionsAdmittedBy")
  admissionsDischarged    Admission[]           @relation("AdmissionsDischarged")
  nursingNotes            NursingNote[]         @relation("NursingNotes")
  chatRoomsCreated        ChatRoom[]            @relation("ChatRoomCreator")
  chatParticipants        ChatParticipant[]     @relation("ChatParticipants")
  chatMessagesSent        ChatMessage[]         @relation("ChatMessages")
  chatAttachmentsUploaded ChatAttachment[]      @relation("ChatAttachments")
  chatReadReceipts        ChatReadReceipt[]     @relation("ChatReadReceipts")
  chatAuditLogs           ChatAuditLog[]        @relation("ChatAuditLogs")
  // Inventory Usage Relations
  nursingInventoryUsage   NursingInventoryUsage[] @relation("NursingInventoryUsage")
  labInventoryUsage       LabInventoryUsage[]     @relation("LabInventoryUsage")
  // HMO Relations
  encountersAsDoctor      Encounter[]           @relation("EncounterDoctor")
  proceduresPerformed     EncounterProcedure[]  @relation("ProcedurePerformer")
  attachmentsUploaded     EncounterAttachment[] @relation("AttachmentUploader")
  claimBatchesCreated     ClaimBatch[]          @relation("BatchCreator")
  claimSubmissions        ClaimSubmission[]     @relation("SubmissionCreator")

  @@unique([hospitalId, email], name: "hospitalId_email")
  @@index([hospitalId])
  @@index([email])
  @@index([passwordResetToken])
  @@map("users")
}

model Patient {
  id                  Int          @id @default(autoincrement())
  hospitalId          Int          @map("hospital_id")
  userId              Int?         @unique @map("user_id")
  primaryDoctorId     Int?         @map("primary_doctor_id")
  patientType         PatientType  @default(self_pay) @map("patient_type")
  corporateClientId   Int?         @map("corporate_client_id")
  firstName           String       @map("first_name")
  lastName            String       @map("last_name")
  hospitalNumber      String?      @map("hospital_number") // Family/household hospital number (can be shared)
  dob                 DateTime     @db.Date
  gender              String?
  tribe               String?      // Patient's tribe/ethnicity
  contactInfo         Json?        @map("contact_info")
  address             String?      @db.Text
  emergencyContact    String?      @map("emergency_contact") @db.Text
  insuranceId         Int?         @map("insurance_id")
  hmoEnrolleeNumber   String?      @map("hmo_enrollee_number") // HMO enrollee/member number
  bloodGroup          String?      @map("blood_group")
  allergies           Json?        // Allergy summary: ["Penicillin", "Peanuts", etc.]
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  // Relations
  hospital        Hospital          @relation(fields: [hospitalId], references: [id])
  user            User?             @relation(fields: [userId], references: [id])
  primaryDoctor     User?             @relation("PrimaryDoctor", fields: [primaryDoctorId], references: [id])
  corporateClient   CorporateClient?  @relation(fields: [corporateClientId], references: [id])
  hmo               Hmo?              @relation(fields: [insuranceId], references: [id])
  appointments      Appointment[]
  medicalRecords    MedicalRecord[]
  prescriptions     Prescription[]
  invoices          Invoice[]
  patientSurveys    PatientSurvey[]
  labOrders         LabOrder[]
  surveyResponses   SurveyResponse[]
  vitals                Vital[]
  admissions            Admission[]
  nursingNotes          NursingNote[]
  encounters            Encounter[] // HMO encounters
  nursingInventoryUsage NursingInventoryUsage[]
  labInventoryUsage     LabInventoryUsage[]

  @@index([hospitalId])
  @@index([userId])
  @@index([primaryDoctorId])
  @@index([corporateClientId])
  @@index([insuranceId])
  @@index([hospitalNumber])
  @@map("patients")
}

model Hmo {
  id                    Int                      @id @default(autoincrement())
  hospitalId            Int                      @map("hospital_id")
  name                  String                   // e.g., "Reliance HMO", "AXA Mansard"
  policyName            String?                  @map("policy_name")
  provider              String?
  providerCode          String?                  @map("provider_code") // Hospital's provider code with this HMO
  submissionMethod      ClaimSubmissionMethod    @default(email_pdf) @map("submission_method")
  requiredFormat        String?                  @map("required_format") // "PDF", "Excel", "CSV"
  submissionEmail       String?                  @map("submission_email")
  submissionPortalUrl   String?                  @map("submission_portal_url")
  codingStandard        HMOCodingStandard        @default(icd10) @map("coding_standard")
  requiresAuthorization Boolean                  @default(true) @map("requires_authorization")
  coverageDetails       Json?                    @map("coverage_details") // JSON with covered services, percentages
  copaymentRules        Json?                    @map("copayment_rules") // JSON with copayment rules
  active                Boolean                  @default(true)
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")

  // Relations
  hospital           Hospital             @relation(fields: [hospitalId], references: [id])
  patients           Patient[]
  hmoplans           HmoPlan[]
  fieldMappings      HmoFieldMapping[]
  encounters         Encounter[]
  claimBatches       ClaimBatch[]
  claimSubmissions   ClaimSubmission[]
  tariffs            HmoTariff[]          @relation("HmoTariffs")

  @@unique([hospitalId, name], name: "hospitalId_name")
  @@index([hospitalId])
  @@index([name])
  @@map("hmo")
}

model CorporateClient {
  id              Int       @id @default(autoincrement())
  hospitalId      Int       @map("hospital_id")
  companyName     String    @map("company_name")
  contactPerson   String?   @map("contact_person")
  contactEmail    String?   @map("contact_email")
  contactPhone    String?   @map("contact_phone")
  billingAddress  String?   @map("billing_address") @db.Text
  paymentTerms    String?   @map("payment_terms")
  discountRate    Decimal?  @map("discount_rate") @db.Decimal(5, 2)
  creditLimit     Decimal?  @map("credit_limit") @db.Decimal(15, 2)
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  hospital Hospital  @relation(fields: [hospitalId], references: [id])
  patients Patient[]

  @@index([hospitalId])
  @@map("corporate_clients")
}

model Appointment {
  id              Int               @id @default(autoincrement())
  hospitalId      Int               @map("hospital_id")
  patientId       Int               @map("patient_id")
  doctorId        Int               @map("doctor_id")
  department      String?
  appointmentType AppointmentType   @map("appointment_type")
  status          AppointmentStatus
  isEmergency     Boolean           @default(false) @map("is_emergency") // Priority flag for emergency cases
  skipVitals      Boolean           @default(false) @map("skip_vitals") // Skip vitals for this visit
  startTime       DateTime          @map("start_time")
  endTime         DateTime?         @map("end_time")
  checkedInAt     DateTime?         @map("checked_in_at") // Actual check-in time
  vitalsCompletedAt DateTime?       @map("vitals_completed_at") // When vitals were recorded
  doctorStartedAt DateTime?         @map("doctor_started_at") // When doctor consultation began
  doctorCompletedAt DateTime?       @map("doctor_completed_at") // When doctor consultation ended
  labStartedAt    DateTime?         @map("lab_started_at") // When lab tests began
  labCompletedAt  DateTime?         @map("lab_completed_at") // When lab tests completed
  pharmacyStartedAt DateTime?       @map("pharmacy_started_at") // When pharmacy dispensing began
  pharmacyCompletedAt DateTime?     @map("pharmacy_completed_at") // When pharmacy dispensing completed
  checkedOutAt    DateTime?         @map("checked_out_at") // Actual check-out time
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])
  doctor   User     @relation(fields: [doctorId], references: [id])
  vitals   Vital[]
  nursingNotes NursingNote[]

  @@index([hospitalId])
  @@index([patientId])
  @@index([doctorId])
  @@index([startTime])
  @@map("appointments")
}

model MedicalRecord {
  id            Int      @id @default(autoincrement())
  hospitalId    Int      @map("hospital_id")
  patientId     Int      @map("patient_id")
  doctorId      Int      @map("doctor_id")
  visitDate     DateTime @map("visit_date") @db.Date
  diagnosis     String?  @db.Text
  notes         String?  @db.Text
  treatmentPlan String?  @map("treatment_plan") @db.Text
  allergies     Json?    // Allergies noted during this visit: ["Penicillin", "Latex", etc.]
  attachments   Json?
  editHistory   Json?    @map("edit_history") // Track edits: [{ doctorId, doctorName, editedAt, changes }]
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])
  doctor   User     @relation(fields: [doctorId], references: [id])

  @@index([hospitalId])
  @@index([patientId])
  @@index([doctorId])
  @@map("medical_records")
}

model Prescription {
  id            Int                  @id @default(autoincrement())
  hospitalId    Int                  @map("hospital_id")
  patientId     Int                  @map("patient_id")
  doctorId      Int                  @map("doctor_id")
  treatmentPlan String?              @map("treatment_plan") @db.Text
  status        PrescriptionStatus?
  drugCount     Int                  @default(0) @map("drug_count")
  dispensedBy   Int?                 @map("dispensed_by") // Pharmacist who dispensed
  dispensedAt   DateTime?            @map("dispensed_at") // When it was dispensed
  invoiceId     Int?                 @map("invoice_id") // Auto-generated invoice
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")

  // Relations
  hospital          Hospital            @relation(fields: [hospitalId], references: [id])
  patient           Patient             @relation(fields: [patientId], references: [id])
  doctor            User                @relation(fields: [doctorId], references: [id])
  pharmacist        User?               @relation("DispensedBy", fields: [dispensedBy], references: [id])
  invoice           Invoice?            @relation(fields: [invoiceId], references: [id])
  prescriptionItems PrescriptionItem[]

  @@index([hospitalId])
  @@index([patientId])
  @@index([doctorId])
  @@index([dispensedBy])
  @@index([invoiceId])
  @@map("prescriptions")
}

model PrescriptionItem {
  id              Int      @id @default(autoincrement())
  prescriptionId  Int      @map("prescription_id")
  drugName        String   @map("drug_name")
  drugCategory    String?  @map("drug_category") // e.g., "Antimalarial", "Antibiotic", "Analgesic"
  dosage          String?
  frequency       String?
  duration        String? // Duration value
  durationUnit    String?  @default("days") @map("duration_unit") // "days", "weeks", "months"
  totalTablets    Int?     @map("total_tablets") // Auto-calculated: dosage × frequency × duration
  packagesNeeded  Int?     @map("packages_needed") // Packages to dispense (calculated)
  inventoryId     Int?     @map("inventory_id") // Link to inventory if available
  isCustomDrug    Boolean  @default(false) @map("is_custom_drug") // True if not in facility inventory
  
  // Pricing fields (calculated at prescription time based on patient type)
  unitPrice       Decimal? @map("unit_price") @db.Decimal(10, 2) // Price per tablet/unit
  subtotal        Decimal? @default(0) @map("subtotal") @db.Decimal(10, 2) // totalTablets × unitPrice
  hmoContribution Decimal? @default(0) @map("hmo_contribution") @db.Decimal(10, 2) // Amount HMO pays
  patientPays     Decimal? @default(0) @map("patient_pays") @db.Decimal(10, 2) // Amount patient pays
  
  notes           String?  @db.Text

  // Relations
  prescription Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  inventory    Inventory?   @relation(fields: [inventoryId], references: [id])

  @@index([prescriptionId])
  @@index([inventoryId])
  @@map("prescription_items")
}

model Inventory {
  id                 Int       @id @default(autoincrement())
  hospitalId         Int       @map("hospital_id")
  itemName           String    @map("item_name")
  itemCode           String?   @map("item_code") // Batch number (optional, not unique since many items won't have one)
  category           String?   // "Medication", "Supply", "Equipment", "Lab", "Nursing"
  drugCategory       String?   @map("drug_category") // "Antimalarial", "Antibiotic", "Analgesic", etc.
  dosageForm         String?   @map("dosage_form") // "Tablet", "Capsule", "Syrup", "Injection", etc.
  dosageStrength     String?   @map("dosage_strength") // e.g., "500mg", "250mg/5ml"
  stockQuantity      Int       @default(0) @map("stock_quantity")
  packagingUnit      String?   @default("tablet") @map("packaging_unit") // "tablet", "capsule", "bottle", "box", "pack"
  tabletsPerPackage  Int?      @default(1) @map("tablets_per_package") // For calculating total tablets
  reorderLevel       Int       @default(10) @map("reorder_level")
  unitPrice          Decimal?  @map("unit_price") @db.Decimal(10, 2) // Self-pay price per unit
  hmoPrice           Decimal?  @map("hmo_price") @db.Decimal(10, 2) // HMO pricing
  corporatePrice     Decimal?  @map("corporate_price") @db.Decimal(10, 2) // Corporate pricing
  expiryDate         DateTime? @map("expiry_date") @db.Date
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  hospital          Hospital              @relation(fields: [hospitalId], references: [id])
  prescriptionItems PrescriptionItem[]
  nursingUsage      NursingInventoryUsage[]
  labUsage          LabInventoryUsage[]

  @@index([hospitalId])
  @@index([stockQuantity])
  @@index([category])
  @@index([drugCategory])
  @@map("inventory")
}

model Invoice {
  id                Int            @id @default(autoincrement())
  hospitalId        Int            @map("hospital_id")
  patientId         Int?           @map("patient_id") // Optional for walk-in/casual patients
  customPatientName String?        @map("custom_patient_name") // Name for non-registered patients
  appointmentId     Int?           @map("appointment_id")
  totalAmount       Decimal        @map("total_amount") @db.Decimal(10, 2)
  paidAmount        Decimal        @default(0) @map("paid_amount") @db.Decimal(10, 2)
  status            InvoiceStatus
  paymentMethod     String?        @map("payment_method")
  hmoId             Int?           @map("hmo_id")
  notes             String?        @db.Text
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  // Relations
  hospital      Hospital       @relation(fields: [hospitalId], references: [id])
  patient       Patient?       @relation(fields: [patientId], references: [id])
  payments      Payment[]
  invoiceItems  InvoiceItem[]
  prescriptions Prescription[] // Prescriptions linked to this invoice

  @@index([hospitalId])
  @@index([patientId])
  @@index([status])
  @@map("invoices")
}

model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int      @map("invoice_id")
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  amount      Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

model Payment {
  id             Int      @id @default(autoincrement())
  invoiceId      Int      @map("invoice_id")
  amountPaid     Decimal  @map("amount_paid") @db.Decimal(10, 2)
  paymentDate    DateTime @map("payment_date")
  paymentGateway String?  @map("payment_gateway")
  transactionRef String?  @unique @map("transaction_ref")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

model Notification {
  id               Int                 @id @default(autoincrement())
  hospitalId       Int                 @map("hospital_id")
  userId           Int?                @map("user_id")
  senderId         Int?                @map("sender_id")
  notificationType NotificationType    @map("notification_type")
  referenceId      Int?                @map("reference_id")
  referenceTable   String?             @map("reference_table")
  deliveryMethod   DeliveryMethod      @map("delivery_method")
  message          String              @db.Text
  status           NotificationStatus
  createdAt        DateTime            @default(now()) @map("created_at")
  sentAt           DateTime?           @map("sent_at")
  readAt           DateTime?           @map("read_at")

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id])
  user     User?    @relation("NotificationRecipient", fields: [userId], references: [id])
  sender   User?    @relation("NotificationSender", fields: [senderId], references: [id])

  @@index([hospitalId])
  @@index([userId])
  @@index([status])
  @@map("notifications")
}

model PatientSurvey {
  id          Int      @id @default(autoincrement())
  hospitalId  Int      @map("hospital_id")
  patientId   Int      @map("patient_id")
  surveyData  Json     @map("survey_data")
  submittedAt DateTime @default(now()) @map("submitted_at")

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id])
  patient  Patient  @relation(fields: [patientId], references: [id])

  @@index([hospitalId])
  @@index([patientId])
  @@map("patient_surveys")
}

model LabOrder {
  id          Int            @id @default(autoincrement())
  hospitalId  Int            @map("hospital_id")
  patientId   Int            @map("patient_id")
  orderedBy   Int            @map("ordered_by")
  assignedTo  Int?           @map("assigned_to")
  orderType   LabOrderType   @map("order_type")
  description String?        @db.Text
  status      LabOrderStatus?
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  // Relations
  hospital       Hospital    @relation(fields: [hospitalId], references: [id])
  patient        Patient     @relation(fields: [patientId], references: [id])
  doctor         User        @relation("OrderedBy", fields: [orderedBy], references: [id])
  assignedLabTech User?      @relation("AssignedLabTech", fields: [assignedTo], references: [id])
  labResults     LabResult[]
  inventoryUsage LabInventoryUsage[]

  @@index([hospitalId])
  @@index([patientId])
  @@index([orderedBy])
  @@index([assignedTo])
  @@index([status])
  @@map("lab_orders")
}

model LabResult {
  id                 Int       @id @default(autoincrement())
  labOrderId         Int       @map("lab_order_id")
  uploadedBy         Int       @map("uploaded_by")
  fileUrl            String?   @map("file_url") @db.Text
  resultNotes        String?   @map("result_notes") @db.Text
  doctorNote         String?   @map("doctor_note") @db.Text
  finalized          Boolean   @default(false)
  releasedToPatient  Boolean   @default(false) @map("released_to_patient")
  releasedAt         DateTime? @map("released_at")
  releasedBy         Int?      @map("released_by")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  labOrder        LabOrder                @relation(fields: [labOrderId], references: [id])
  uploader        User                    @relation("UploadedBy", fields: [uploadedBy], references: [id])
  releaser        User?                   @relation("ReleasedBy", fields: [releasedBy], references: [id])
  labResultValues LabResultValue[]
  attachments     LabResultAttachment[]

  @@index([labOrderId])
  @@index([uploadedBy])
  @@index([releasedBy])
  @@index([releasedToPatient])
  @@map("lab_results")
}

model LabResultValue {
  id          Int      @id @default(autoincrement())
  labResultId Int      @map("lab_result_id")
  testName    String   @map("test_name")
  resultValue String?  @map("result_value")
  unit        String?
  normalRange String?  @map("normal_range")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  labResult LabResult @relation(fields: [labResultId], references: [id], onDelete: Cascade)

  @@index([labResultId])
  @@map("lab_result_values")
}

model LabResultAttachment {
  id          Int      @id @default(autoincrement())
  labResultId Int      @map("lab_result_id")
  fileName    String   @map("file_name")
  fileType    String   @map("file_type")
  fileData    String   @map("file_data") @db.Text
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  // Relations
  labResult LabResult @relation(fields: [labResultId], references: [id], onDelete: Cascade)

  @@index([labResultId])
  @@map("lab_result_attachments")
}

model AnalyticsDashboard {
  id            Int            @id @default(autoincrement())
  hospitalId    Int            @map("hospital_id")
  dashboardName String         @map("dashboard_name")
  dashboardType DashboardType? @map("dashboard_type")
  config        Json?
  createdBy     Int?           @map("created_by")
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id])
  creator  User?    @relation("DashboardCreator", fields: [createdBy], references: [id])

  @@index([hospitalId])
  @@map("analytics_dashboards")
}

model AnalyticsReport {
  id                Int           @id @default(autoincrement())
  hospitalId        Int           @map("hospital_id")
  reportType        ReportType?   @map("report_type")
  reportPeriodStart DateTime      @map("report_period_start") @db.Date
  reportPeriodEnd   DateTime      @map("report_period_end") @db.Date
  generatedBy       Int?          @map("generated_by")
  reportData        Json?         @map("report_data")
  fileUrl           String?       @map("file_url") @db.Text
  status            ReportStatus?
  createdAt         DateTime      @default(now()) @map("created_at")

  // Relations
  hospital  Hospital @relation(fields: [hospitalId], references: [id])
  generator User?    @relation("ReportGenerator", fields: [generatedBy], references: [id])

  @@index([hospitalId])
  @@index([status])
  @@map("analytics_reports")
}

model AnalyticsMetric {
  id             Int         @id @default(autoincrement())
  hospitalId     Int         @map("hospital_id")
  metricDate     DateTime    @map("metric_date") @db.Date
  metricType     String      @map("metric_type")
  metricValue    Decimal?    @map("metric_value") @db.Decimal(15, 2)
  metricUnit     String?     @map("metric_unit")
  patientType    PatientType? @map("patient_type")
  additionalData Json?       @map("additional_data")
  createdAt      DateTime    @default(now()) @map("created_at")

  // Relations
  hospital Hospital @relation(fields: [hospitalId], references: [id])

  @@index([hospitalId])
  @@index([metricDate])
  @@index([metricType])
  @@map("analytics_metrics")
}

enum SurveyStatus {
  draft
  active
  closed
}

enum QuestionType {
  short_text
  long_text
  multiple_choice
  checkboxes
  rating
  yes_no
  date
  linear_scale
}

model Survey {
  id          Int          @id @default(autoincrement())
  hospitalId  Int          @map("hospital_id")
  title       String
  description String?      @db.Text
  status      SurveyStatus @default(draft)
  createdBy   Int          @map("created_by")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  hospital  Hospital         @relation(fields: [hospitalId], references: [id])
  creator   User             @relation(fields: [createdBy], references: [id])
  questions SurveyQuestion[]
  responses SurveyResponse[]

  @@index([hospitalId])
  @@index([status])
  @@map("surveys")
}

model SurveyQuestion {
  id           Int          @id @default(autoincrement())
  surveyId     Int          @map("survey_id")
  questionText String       @map("question_text") @db.Text
  questionType QuestionType @map("question_type")
  options      Json?        // For multiple choice/checkboxes: ["Option 1", "Option 2"]
  required     Boolean      @default(false)
  order        Int          @default(0)
  createdAt    DateTime     @default(now()) @map("created_at")

  // Relations
  survey  Survey         @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  answers SurveyAnswer[]

  @@index([surveyId])
  @@map("survey_questions")
}

model SurveyResponse {
  id          Int      @id @default(autoincrement())
  surveyId    Int      @map("survey_id")
  patientId   Int      @map("patient_id")
  completedAt DateTime @default(now()) @map("completed_at")

  // Relations
  survey  Survey         @relation(fields: [surveyId], references: [id])
  patient Patient        @relation(fields: [patientId], references: [id])
  answers SurveyAnswer[]

  @@unique([surveyId, patientId]) // One response per patient per survey
  @@index([surveyId])
  @@index([patientId])
  @@map("survey_responses")
}

model SurveyAnswer {
  id         Int    @id @default(autoincrement())
  responseId Int    @map("response_id")
  questionId Int    @map("question_id")
  answer     String @db.Text // Store answer as string (can be JSON for multiple selections)

  // Relations
  response SurveyResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  question SurveyQuestion @relation(fields: [questionId], references: [id])

  @@index([responseId])
  @@index([questionId])
  @@map("survey_answers")
}

// ===================================
// VITALS & ADMISSIONS
// ===================================

enum AdmissionStatus {
  admitted
  in_treatment
  discharged
  transferred
}

model Vital {
  id               Int      @id @default(autoincrement())
  hospitalId       Int      @map("hospital_id")
  patientId        Int      @map("patient_id")
  recordedBy       Int      @map("recorded_by")
  appointmentId    Int?     @map("appointment_id")
  temperature      Decimal? @db.Decimal(4, 1) // Celsius, e.g., 37.5
  bloodPressureSys Int?     @map("blood_pressure_sys") // Systolic, e.g., 120
  bloodPressureDia Int?     @map("blood_pressure_dia") // Diastolic, e.g., 80
  heartRate        Int?     @map("heart_rate") // BPM
  respiratoryRate  Int?     @map("respiratory_rate") // Breaths per minute
  oxygenSaturation Decimal? @map("oxygen_saturation") @db.Decimal(5, 2) // SpO2, e.g., 98.5
  weight           Decimal? @db.Decimal(5, 2) // kg
  height           Decimal? @db.Decimal(5, 2) // cm
  bmi              Decimal? @db.Decimal(4, 2) // Calculated
  notes            String?  @db.Text
  recordedAt       DateTime @default(now()) @map("recorded_at")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  patient      Patient      @relation(fields: [patientId], references: [id])
  recordedByUser User       @relation("VitalsRecordedBy", fields: [recordedBy], references: [id])
  appointment  Appointment? @relation(fields: [appointmentId], references: [id])

  @@index([hospitalId])
  @@index([patientId])
  @@index([recordedBy])
  @@index([appointmentId])
  @@index([recordedAt])
  @@map("vitals")
}

model Admission {
  id                 Int              @id @default(autoincrement())
  hospitalId         Int              @map("hospital_id")
  patientId          Int              @map("patient_id")
  admittedBy         Int              @map("admitted_by")
  dischargedBy       Int?             @map("discharged_by")
  ward               String?
  bedNumber          String?          @map("bed_number")
  admissionReason    String           @map("admission_reason") @db.Text
  admissionDate      DateTime         @map("admission_date")
  dischargeDate      DateTime?        @map("discharge_date")
  status             AdmissionStatus  @default(admitted)
  dischargeSummary   String?          @map("discharge_summary") @db.Text
  followUpInstructions String?        @map("follow_up_instructions") @db.Text
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  // Relations
  patient         Patient @relation(fields: [patientId], references: [id])
  admittingDoctor User    @relation("AdmissionsAdmittedBy", fields: [admittedBy], references: [id])
  dischargingDoctor User? @relation("AdmissionsDischarged", fields: [dischargedBy], references: [id])

  @@index([hospitalId])
  @@index([patientId])
  @@index([admittedBy])
  @@index([status])
  @@index([admissionDate])
  @@map("admissions")
}

model NursingNote {
  id            Int      @id @default(autoincrement())
  hospitalId    Int      @map("hospital_id")
  patientId     Int      @map("patient_id")
  nurseId       Int      @map("nurse_id")
  appointmentId Int?     @map("appointment_id")
  noteType      String   @map("note_type") // e.g., "assessment", "intervention", "progress", "discharge_planning"
  note          String   @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  patient      Patient      @relation(fields: [patientId], references: [id])
  nurse        User         @relation("NursingNotes", fields: [nurseId], references: [id])
  appointment  Appointment? @relation(fields: [appointmentId], references: [id])

  @@index([hospitalId])
  @@index([patientId])
  @@index([nurseId])
  @@index([appointmentId])
  @@index([createdAt])
  @@map("nursing_notes")
}

// ===================================
// SECURE CHAT SYSTEM (NDPR/HIPAA Compliant)
// ===================================

enum ChatRoomType {
  general
  private
}

enum MessageStatus {
  sent
  delivered
  read
}

model ChatRoom {
  id          Int          @id @default(autoincrement())
  hospitalId  Int          @map("hospital_id")
  roomType    ChatRoomType @map("room_type")
  name        String?      // Name for general chats
  createdBy   Int          @map("created_by")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  creator      User                @relation("ChatRoomCreator", fields: [createdBy], references: [id])
  messages     ChatMessage[]
  participants ChatParticipant[]
  attachments  ChatAttachment[]

  @@index([hospitalId])
  @@index([roomType])
  @@index([createdBy])
  @@map("chat_rooms")
}

model ChatParticipant {
  id             Int       @id @default(autoincrement())
  roomId         Int       @map("room_id")
  userId         Int       @map("user_id")
  lastRead       DateTime? @map("last_read")
  joinedAt       DateTime  @default(now()) @map("joined_at")
  unreadCount    Int       @default(0) @map("unread_count")

  // Relations
  room ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User     @relation("ChatParticipants", fields: [userId], references: [id])

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@map("chat_participants")
}

model ChatMessage {
  id                Int           @id @default(autoincrement())
  roomId            Int           @map("room_id")
  senderId          Int           @map("sender_id")
  encryptedContent  String        @map("encrypted_content") @db.Text
  status            MessageStatus @default(sent)
  mentionedUserIds  Int[]         @map("mentioned_user_ids") // Array of user IDs tagged with @
  replyToMessageId  Int?          @map("reply_to_message_id")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at")

  // Relations
  room           ChatRoom          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender         User              @relation("ChatMessages", fields: [senderId], references: [id])
  replyTo        ChatMessage?      @relation("MessageReplies", fields: [replyToMessageId], references: [id])
  replies        ChatMessage[]     @relation("MessageReplies")
  attachments    ChatAttachment[]
  readReceipts   ChatReadReceipt[]

  @@index([roomId])
  @@index([senderId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("chat_messages")
}

model ChatAttachment {
  id                Int      @id @default(autoincrement())
  roomId            Int      @map("room_id")
  messageId         Int?     @map("message_id")
  uploadedBy        Int      @map("uploaded_by")
  originalFileName  String   @map("original_file_name")
  fileType          String   @map("file_type")
  fileSize          Int      @map("file_size") // In bytes
  encryptedData     String   @map("encrypted_data") @db.Text
  encryptionKey     String   @map("encryption_key") @db.Text // Encrypted with master key
  uploadedAt        DateTime @default(now()) @map("uploaded_at")

  // Relations
  room     ChatRoom     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  message  ChatMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  uploader User         @relation("ChatAttachments", fields: [uploadedBy], references: [id])

  @@index([roomId])
  @@index([messageId])
  @@index([uploadedBy])
  @@map("chat_attachments")
}

model ChatReadReceipt {
  id        Int      @id @default(autoincrement())
  messageId Int      @map("message_id")
  userId    Int      @map("user_id")
  readAt    DateTime @default(now()) @map("read_at")

  // Relations
  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User        @relation("ChatReadReceipts", fields: [userId], references: [id])

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@map("chat_read_receipts")
}

model ChatAuditLog {
  id          Int      @id @default(autoincrement())
  hospitalId  Int      @map("hospital_id")
  userId      Int      @map("user_id")
  action      String   // "send", "read", "download", "delete"
  resourceType String  @map("resource_type") // "message", "attachment"
  resourceId   Int     @map("resource_id")
  metadata    Json?    // Additional context
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation("ChatAuditLogs", fields: [userId], references: [id])

  @@index([hospitalId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("chat_audit_logs")
}

// ===================================
// HMO CLAIMS MANAGEMENT MODELS
// ===================================

model HmoPlan {
  id                Int      @id @default(autoincrement())
  hmoId             Int      @map("hmo_id")
  planName          String   @map("plan_name") // e.g., "Gold Plan", "Family Plan"
  planCode          String?  @map("plan_code")
  coverageLimit     Decimal? @map("coverage_limit") @db.Decimal(15, 2)
  copayPercentage   Decimal? @map("copay_percentage") @db.Decimal(5, 2)
  coveredServices   Json?    @map("covered_services") // Array of service types/codes
  excludedServices  Json?    @map("excluded_services")
  active            Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  hmo Hmo @relation(fields: [hmoId], references: [id], onDelete: Cascade)

  @@index([hmoId])
  @@map("hmo_plans")
}

model HmoFieldMapping {
  id            Int      @id @default(autoincrement())
  hmoId         Int      @map("hmo_id")
  emrField      String   @map("emr_field") // Our internal field name
  hmoField      String   @map("hmo_field") // HMO's required field name
  fieldType     String   @map("field_type") // "text", "number", "date", "code"
  isMandatory   Boolean  @default(false) @map("is_mandatory")
  defaultValue  String?  @map("default_value")
  transformation String? // JSON string with transformation rules if needed
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  hmo Hmo @relation(fields: [hmoId], references: [id], onDelete: Cascade)

  @@index([hmoId])
  @@index([emrField])
  @@map("hmo_field_mappings")
}

model Encounter {
  id                    Int          @id @default(autoincrement())
  hospitalId            Int          @map("hospital_id")
  patientId             Int          @map("patient_id")
  hmoId                 Int?         @map("hmo_id")
  doctorId              Int          @map("doctor_id")
  visitDate             DateTime     @map("visit_date")
  encounterType         String       @map("encounter_type") // "OPD", "IPD", "Emergency"
  admissionDate         DateTime?    @map("admission_date")
  dischargeDate         DateTime?    @map("discharge_date")
  authorizationCode     String?      @map("authorization_code")
  chiefComplaint        String?      @map("chief_complaint") @db.Text
  notes                 String?      @db.Text
  claimStatus           ClaimStatus  @default(draft) @map("claim_status")
  totalAmount           Decimal      @default(0) @map("total_amount") @db.Decimal(15, 2)
  hmoCoveredAmount      Decimal      @default(0) @map("hmo_covered_amount") @db.Decimal(15, 2)
  patientCopayAmount    Decimal      @default(0) @map("patient_copay_amount") @db.Decimal(15, 2)
  patientPaidAmount     Decimal      @default(0) @map("patient_paid_amount") @db.Decimal(15, 2)
  paystackAuthCode      String?      @map("paystack_auth_code") // For recurring charges
  claimBatchId          Int?         @map("claim_batch_id")
  readyForClaimsAt      DateTime?    @map("ready_for_claims_at")
  submittedAt           DateTime?    @map("submitted_at")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  // Relations
  hospital      Hospital           @relation(fields: [hospitalId], references: [id])
  patient       Patient            @relation(fields: [patientId], references: [id])
  hmo           Hmo?               @relation(fields: [hmoId], references: [id])
  doctor        User               @relation("EncounterDoctor", fields: [doctorId], references: [id])
  claimBatch    ClaimBatch?        @relation(fields: [claimBatchId], references: [id])
  diagnoses     EncounterDiagnosis[]
  procedures    EncounterProcedure[]
  billingItems  EncounterBillingItem[]
  attachments   EncounterAttachment[]

  @@index([hospitalId])
  @@index([patientId])
  @@index([hmoId])
  @@index([doctorId])
  @@index([claimStatus])
  @@index([visitDate])
  @@index([claimBatchId])
  @@map("encounters")
}

model EncounterDiagnosis {
  id           Int      @id @default(autoincrement())
  encounterId  Int      @map("encounter_id")
  diagnosisCode String  @map("diagnosis_code") // ICD-10 code
  description   String
  isPrimary    Boolean  @default(false) @map("is_primary")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@map("encounter_diagnoses")
}

model EncounterProcedure {
  id             Int      @id @default(autoincrement())
  encounterId    Int      @map("encounter_id")
  procedureCode  String   @map("procedure_code") // CPT or local code
  description    String
  quantity       Int      @default(1)
  unitCost       Decimal  @map("unit_cost") @db.Decimal(15, 2)
  totalCost      Decimal  @map("total_cost") @db.Decimal(15, 2)
  performedAt    DateTime @map("performed_at")
  performedById  Int?     @map("performed_by_id")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  encounter    Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  performedBy  User?     @relation("ProcedurePerformer", fields: [performedById], references: [id])

  @@index([encounterId])
  @@map("encounter_procedures")
}

model EncounterBillingItem {
  id              Int      @id @default(autoincrement())
  encounterId     Int      @map("encounter_id")
  serviceId       String?  @map("service_id") // Internal service code
  description     String
  quantity        Int      @default(1)
  unitCost        Decimal  @map("unit_cost") @db.Decimal(15, 2)
  totalCost       Decimal  @map("total_cost") @db.Decimal(15, 2)
  isCoveredByHmo  Boolean  @default(true) @map("is_covered_by_hmo")
  hmoCoverage     Decimal? @map("hmo_coverage") @db.Decimal(5, 2) // Percentage
  hmoAmount       Decimal  @default(0) @map("hmo_amount") @db.Decimal(15, 2)
  patientAmount   Decimal  @default(0) @map("patient_amount") @db.Decimal(15, 2)
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([encounterId])
  @@map("encounter_billing_items")
}

model EncounterAttachment {
  id           Int      @id @default(autoincrement())
  encounterId  Int      @map("encounter_id")
  fileName     String   @map("file_name")
  fileUrl      String   @map("file_url")
  fileType     String   @map("file_type") // "lab_result", "imaging", "prescription", "other"
  description  String?
  uploadedById Int      @map("uploaded_by_id")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  // Relations
  encounter  Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  uploadedBy User      @relation("AttachmentUploader", fields: [uploadedById], references: [id])

  @@index([encounterId])
  @@map("encounter_attachments")
}

model ClaimBatch {
  id                Int      @id @default(autoincrement())
  hospitalId        Int      @map("hospital_id")
  hmoId             Int      @map("hmo_id")
  batchNumber       String   @unique @map("batch_number") // e.g., "RLH-2024-001"
  batchDate         DateTime @map("batch_date")
  encounterCount    Int      @default(0) @map("encounter_count")
  totalAmount       Decimal  @map("total_amount") @db.Decimal(15, 2)
  status            ClaimStatus @default(batching)
  generatedFileUrl  String?  @map("generated_file_url") // URL to exported claim file in B2
  submissionNotes   String?  @map("submission_notes") @db.Text
  createdById       Int      @map("created_by_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  hospital    Hospital          @relation(fields: [hospitalId], references: [id])
  hmo         Hmo               @relation(fields: [hmoId], references: [id])
  createdBy   User              @relation("BatchCreator", fields: [createdById], references: [id])
  encounters  Encounter[]
  submissions ClaimSubmission[]

  @@index([hospitalId])
  @@index([hmoId])
  @@index([status])
  @@index([batchDate])
  @@map("claim_batches")
}

model ClaimSubmission {
  id                  Int          @id @default(autoincrement())
  claimBatchId        Int          @map("claim_batch_id")
  hmoId               Int          @map("hmo_id")
  submissionDate      DateTime     @map("submission_date")
  submissionMethod    ClaimSubmissionMethod @map("submission_method")
  submittedAmount     Decimal      @map("submitted_amount") @db.Decimal(15, 2)
  approvedAmount      Decimal?     @map("approved_amount") @db.Decimal(15, 2)
  paidAmount          Decimal?     @map("paid_amount") @db.Decimal(15, 2)
  status              ClaimStatus  @default(submitted)
  responseDate        DateTime?    @map("response_date")
  paymentDate         DateTime?    @map("payment_date")
  queryReason         String?      @map("query_reason") @db.Text
  queryResponse       String?      @map("query_response") @db.Text
  denialReason        String?      @map("denial_reason") @db.Text
  submissionReference String?      @map("submission_reference") // HMO's reference number
  notes               String?      @db.Text
  submittedById       Int          @map("submitted_by_id")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  // Relations
  claimBatch  ClaimBatch @relation(fields: [claimBatchId], references: [id])
  hmo         Hmo        @relation(fields: [hmoId], references: [id])
  submittedBy User       @relation("SubmissionCreator", fields: [submittedById], references: [id])

  @@index([claimBatchId])
  @@index([hmoId])
  @@index([status])
  @@index([submissionDate])
  @@map("claim_submissions")
}

// ===================================
// HMO TARIFF MANAGEMENT MODELS
// ===================================

model HmoTariff {
  id               Int       @id @default(autoincrement())
  hmoId            Int       @map("hmo_id")
  code             String    // Service/procedure/drug code
  name             String    // Item/service name
  category         String?   // Category (e.g., "Medication", "Procedure", "Package")
  unit             String?   // Unit of measure (e.g., "Tab", "Vial", "Session")
  basePrice        Decimal   @map("base_price") @db.Decimal(15, 2)
  tier0Price       Decimal?  @map("tier_0_price") @db.Decimal(15, 2) // For tiered pricing
  tier1Price       Decimal?  @map("tier_1_price") @db.Decimal(15, 2)
  tier2Price       Decimal?  @map("tier_2_price") @db.Decimal(15, 2)
  tier3Price       Decimal?  @map("tier_3_price") @db.Decimal(15, 2)
  tier4Price       Decimal?  @map("tier_4_price") @db.Decimal(15, 2)
  isPARequired     Boolean   @default(false) @map("is_pa_required") // Pre-authorization required
  effectiveDate    DateTime? @map("effective_date")
  expiryDate       DateTime? @map("expiry_date")
  active           Boolean   @default(true)
  metadata         Json?     // Store additional HMO-specific fields
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  hmo Hmo @relation("HmoTariffs", fields: [hmoId], references: [id], onDelete: Cascade)

  @@unique([hmoId, code])
  @@index([hmoId])
  @@index([code])
  @@index([category])
  @@index([name])
  @@map("hmo_tariffs")
}

// ===================================
// INVENTORY USAGE TRACKING MODELS
// ===================================

model NursingInventoryUsage {
  id           Int      @id @default(autoincrement())
  hospitalId   Int      @map("hospital_id")
  patientId    Int      @map("patient_id")
  inventoryId  Int      @map("inventory_id")
  nurseId      Int      @map("nurse_id")
  quantity     Int      @default(1)
  purpose      String?  @db.Text // Reason for usage (e.g., "Wound dressing", "IV setup")
  notes        String?  @db.Text
  usedAt       DateTime @default(now()) @map("used_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  hospital  Hospital  @relation(fields: [hospitalId], references: [id])
  patient   Patient   @relation(fields: [patientId], references: [id])
  inventory Inventory @relation(fields: [inventoryId], references: [id])
  nurse     User      @relation("NursingInventoryUsage", fields: [nurseId], references: [id])

  @@index([hospitalId])
  @@index([patientId])
  @@index([inventoryId])
  @@index([nurseId])
  @@index([usedAt])
  @@map("nursing_inventory_usage")
}

model LabInventoryUsage {
  id           Int      @id @default(autoincrement())
  hospitalId   Int      @map("hospital_id")
  patientId    Int      @map("patient_id")
  labOrderId   Int?     @map("lab_order_id") // Optional link to lab order
  inventoryId  Int      @map("inventory_id")
  labTechId    Int      @map("lab_tech_id")
  quantity     Int      @default(1)
  testType     String?  @map("test_type") // Type of test (e.g., "Blood Test", "Urinalysis")
  notes        String?  @db.Text
  usedAt       DateTime @default(now()) @map("used_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  hospital  Hospital  @relation(fields: [hospitalId], references: [id])
  patient   Patient   @relation(fields: [patientId], references: [id])
  labOrder  LabOrder? @relation(fields: [labOrderId], references: [id])
  inventory Inventory @relation(fields: [inventoryId], references: [id])
  labTech   User      @relation("LabInventoryUsage", fields: [labTechId], references: [id])

  @@index([hospitalId])
  @@index([patientId])
  @@index([labOrderId])
  @@index([inventoryId])
  @@index([labTechId])
  @@index([usedAt])
  @@map("lab_inventory_usage")
}
