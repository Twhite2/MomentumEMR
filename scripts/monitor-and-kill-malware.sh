#!/bin/bash
###############################################################################
# Continuous Malware Monitor
# Runs continuously to detect and kill npm malware immediately
###############################################################################

set -euo pipefail

LOG_FILE="/var/log/malware-monitor.log"
CHECK_INTERVAL=30  # Check every 30 seconds
APP_DIR="/home/momentum/Momentum_EMR"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "========================================="
log "Malware Monitor Started"
log "Checking every ${CHECK_INTERVAL} seconds"
log "========================================="

# Function to get legitimate PIDs
get_legitimate_pids() {
    local pids=()
    
    # PM2 daemon
    local pm2_pid=$(pgrep -f "PM2 v.*God Daemon" | head -1 || echo "")
    if [[ -n "$pm2_pid" ]]; then
        pids+=("$pm2_pid")
    fi
    
    # PM2 apps from correct directory
    local app_pids=$(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="momentum-emr") | .pid' || echo "")
    for app_pid in $app_pids; do
        if [[ -n "$app_pid" && "$app_pid" != "0" && "$app_pid" != "null" ]]; then
            local cwd=$(readlink -f /proc/$app_pid/cwd 2>/dev/null || echo "")
            if [[ "$cwd" == *"Momentum_EMR"* ]]; then
                pids+=("$app_pid")
                # Get all children recursively
                local children=$(pgrep -P "$app_pid" 2>/dev/null || echo "")
                for child in $children; do
                    pids+=("$child")
                done
            fi
        fi
    done
    
    echo "${pids[@]}"
}

# Main monitoring loop
while true; do
    LEGITIMATE_PIDS=($(get_legitimate_pids))
    ALL_NPM_PIDS=$(pgrep -f "npm|node" || echo "")
    KILLED_COUNT=0
    
    for pid in $ALL_NPM_PIDS; do
        # Skip if legitimate
        if [[ " ${LEGITIMATE_PIDS[@]} " =~ " ${pid} " ]]; then
            continue
        fi
        
        # Get process details
        FULL_CMD=$(ps -p $pid -o cmd --no-headers 2>/dev/null || echo "")
        CPU_USAGE=$(ps -p $pid -o %cpu --no-headers 2>/dev/null | tr -d ' ' || echo "0")
        EXE_PATH=$(readlink -f /proc/$pid/exe 2>/dev/null || echo "")
        CWD=$(readlink -f /proc/$pid/cwd 2>/dev/null || echo "")
        
        SHOULD_KILL=false
        REASON=""
        
        # Check for "npm start 1G" signature
        if echo "$FULL_CMD" | grep -qiE "npm start 1G|npm.*1G|node.*1G"; then
            SHOULD_KILL=true
            REASON="npm start 1G malware"
        fi
        
        # High CPU from non-EMR directory
        CPU_INT=$(echo "$CPU_USAGE" | cut -d. -f1)
        if [[ "$CPU_INT" -gt 30 ]] && [[ "$CWD" != *"Momentum_EMR"* ]]; then
            SHOULD_KILL=true
            REASON="High CPU (${CPU_USAGE}%) from wrong directory"
        fi
        
        # Running from temp
        if echo "$EXE_PATH" | grep -qE "^/tmp/|^/var/tmp/|^/dev/shm/"; then
            SHOULD_KILL=true
            REASON="Running from temp: $EXE_PATH"
        fi
        
        # npm/node from wrong directory
        if echo "$FULL_CMD" | grep -qE "npm|node"; then
            if [[ "$CWD" != *"Momentum_EMR"* && "$CWD" != "/root" && "$CWD" != "/home/"* ]]; then
                SHOULD_KILL=true
                REASON="npm/node from suspicious directory: $CWD"
            fi
        fi
        
        if [[ "$SHOULD_KILL" == "true" ]]; then
            log "⚠️  KILLING MALWARE - PID: $pid | CPU: ${CPU_USAGE}% | Reason: $REASON"
            log "   Command: $FULL_CMD"
            
            # Kill it
            kill -9 $pid 2>/dev/null || true
            ((KILLED_COUNT++))
            
            # Clean up the binary if possible
            if [[ -n "$EXE_PATH" && -f "$EXE_PATH" ]] && echo "$EXE_PATH" | grep -qE "^/tmp/|^/var/tmp/"; then
                rm -f "$EXE_PATH" 2>/dev/null || true
                log "   Removed binary: $EXE_PATH"
            fi
        fi
    done
    
    if [[ $KILLED_COUNT -gt 0 ]]; then
        log "✓ Killed $KILLED_COUNT malicious processes"
    fi
    
    sleep $CHECK_INTERVAL
done
