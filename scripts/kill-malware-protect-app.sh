#!/bin/bash
###############################################################################
# Kill Malware & Protect Momentum EMR
# Enhanced script to hunt down npm malware disguised as legitimate processes
###############################################################################

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

LOG_FILE="/var/log/malware-cleanup.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Logging function
log() {
    echo -e "${1}" | tee -a "$LOG_FILE"
}

log_to_file() {
    echo "[$TIMESTAMP] $1" >> "$LOG_FILE"
}

echo "========================================="
log "${BLUE}Enhanced Malware Hunter & App Protection${NC}"
log "${BLUE}Started: $TIMESTAMP${NC}"
echo "========================================="

# APP_DIR - Update this if your directory is different
APP_DIR="/home/momentum/Momentum_EMR"

# Step 1: Get legitimate process info (STRICT WHITELIST)
log "\n${YELLOW}[Step 1/7] Building strict whitelist of legitimate processes...${NC}"

LEGITIMATE_PIDS=()
LEGITIMATE_PATHS=()

# Get PM2 daemon PID (the PM2 God process itself)
PM2_DAEMON_PID=$(pgrep -f "PM2 v.*God Daemon" | head -1 || echo "")
if [[ -n "$PM2_DAEMON_PID" ]]; then
    LEGITIMATE_PIDS+=("$PM2_DAEMON_PID")
    log "${GREEN}✓ PM2 God Daemon PID: $PM2_DAEMON_PID${NC}"
    log_to_file "PM2 Daemon: $PM2_DAEMON_PID"
fi

# Get the ACTUAL momentum-emr app process (must be from correct directory)
PM2_APP_PIDS=$(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="momentum-emr") | .pid' || echo "")
for app_pid in $PM2_APP_PIDS; do
    if [[ -n "$app_pid" && "$app_pid" != "0" && "$app_pid" != "null" ]]; then
        # Verify it's running from the correct directory
        APP_CWD=$(readlink -f /proc/$app_pid/cwd 2>/dev/null || echo "")
        if [[ "$APP_CWD" == *"Momentum_EMR"* ]]; then
            LEGITIMATE_PIDS+=("$app_pid")
            LEGITIMATE_PATHS+=("$APP_CWD")
            log "${GREEN}✓ Momentum EMR App PID: $app_pid (CWD: $APP_CWD)${NC}"
            log_to_file "EMR App: $app_pid CWD=$APP_CWD"
        else
            log "${RED}✗ Suspicious PM2 app: PID $app_pid in wrong directory: $APP_CWD${NC}"
        fi
    fi
done

# Get ALL child processes recursively for whitelisted PIDs
get_all_children() {
    local parent_pid=$1
    local children=$(pgrep -P "$parent_pid" 2>/dev/null || echo "")
    for child in $children; do
        echo "$child"
        get_all_children "$child"
    done
}

for parent_pid in "${LEGITIMATE_PIDS[@]}"; do
    CHILDREN=$(get_all_children "$parent_pid")
    for child_pid in $CHILDREN; do
        if [[ ! " ${LEGITIMATE_PIDS[@]} " =~ " ${child_pid} " ]]; then
            LEGITIMATE_PIDS+=("$child_pid")
            log "${GREEN}✓ Child Process: $child_pid (parent: $parent_pid)${NC}"
            log_to_file "Child: $child_pid"
        fi
    done
done

# Get pnpm processes ONLY if running from correct directory
PNPM_PIDS=$(pgrep -f "pnpm" || echo "")
for pnpm_pid in $PNPM_PIDS; do
    PNPM_CWD=$(readlink -f /proc/$pnpm_pid/cwd 2>/dev/null || echo "")
    if [[ "$PNPM_CWD" == *"Momentum_EMR"* ]]; then
        LEGITIMATE_PIDS+=("$pnpm_pid")
        log "${GREEN}✓ PNPM Process: $pnpm_pid${NC}"
        log_to_file "PNPM: $pnpm_pid"
    fi
done

log "${BLUE}Total legitimate processes protected: ${#LEGITIMATE_PIDS[@]}${NC}"

# Step 2: Find all node/npm processes
log "\n${YELLOW}[Step 2/6] Scanning for all node/npm processes...${NC}"

ALL_NODE_PIDS=$(pgrep -f "node|npm" || echo "")
TOTAL_NODE_PROCESSES=$(echo "$ALL_NODE_PIDS" | wc -w)
log "${BLUE}Found $TOTAL_NODE_PROCESSES node/npm processes${NC}"

# Step 3: Aggressively identify malware (ENHANCED DETECTION)
log "\n${YELLOW}[Step 3/7] Hunting for npm malware with enhanced detection...${NC}"

MALICIOUS_PIDS=()
MALICIOUS_COUNT=0

for pid in $ALL_NODE_PIDS; do
    # Skip if PID is in legitimate list
    if [[ " ${LEGITIMATE_PIDS[@]} " =~ " ${pid} " ]]; then
        continue
    fi
    
    # Get comprehensive process details
    CMDLINE=$(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ' || echo "")
    FULL_CMD=$(ps -p $pid -o cmd --no-headers 2>/dev/null || echo "")
    CPU_USAGE=$(ps -p $pid -o %cpu --no-headers 2>/dev/null | tr -d ' ' || echo "0")
    MEM_USAGE=$(ps -p $pid -o %mem --no-headers 2>/dev/null | tr -d ' ' || echo "0")
    USER=$(ps -p $pid -o user --no-headers 2>/dev/null | tr -d ' ' || echo "")
    EXE_PATH=$(readlink -f /proc/$pid/exe 2>/dev/null || echo "")
    CWD=$(readlink -f /proc/$pid/cwd 2>/dev/null || echo "")
    
    # Check for suspicious patterns (ANY match = KILL)
    IS_SUSPICIOUS=false
    REASONS=()
    
    # Pattern 1: Specific malware signatures
    if echo "$FULL_CMD" | grep -qiE "npm start 1G|npm.*1G|node.*1G"; then
        IS_SUSPICIOUS=true
        REASONS+=("MALWARE_SIGNATURE: npm start 1G detected")
    fi
    
    # Pattern 2: High CPU usage (>20% for non-whitelisted)
    CPU_INT=$(echo "$CPU_USAGE" | cut -d. -f1)
    if [[ "$CPU_INT" -gt 20 ]]; then
        IS_SUSPICIOUS=true
        REASONS+=("HIGH_CPU: ${CPU_USAGE}%")
    fi
    
    # Pattern 3: Running from suspicious locations
    if echo "$EXE_PATH" | grep -qE "^/tmp/|^/var/tmp/|^/dev/shm/"; then
        IS_SUSPICIOUS=true
        REASONS+=("SUSPICIOUS_LOCATION: $EXE_PATH")
    fi
    
    # Pattern 4: CWD in temp directories
    if echo "$CWD" | grep -qE "^/tmp/|^/var/tmp/|^/dev/shm/"; then
        IS_SUSPICIOUS=true
        REASONS+=("TEMP_CWD: $CWD")
    fi
    
    # Pattern 5: UPX packed binary
    if [[ -f "$EXE_PATH" ]]; then
        FILE_TYPE=$(file "$EXE_PATH" 2>/dev/null || echo "")
        if echo "$FILE_TYPE" | grep -qi "UPX compressed"; then
            IS_SUSPICIOUS=true
            REASONS+=("UPX_PACKED")
        fi
    fi
    
    # Pattern 6: Executable name doesn't match real npm/node
    REAL_NODE_PATH=$(which node 2>/dev/null || echo "/usr/bin/node")
    REAL_NPM_PATH=$(which npm 2>/dev/null || echo "/usr/bin/npm")
    if [[ "$EXE_PATH" != "$REAL_NODE_PATH" && "$EXE_PATH" != "$REAL_NPM_PATH" ]]; then
        if echo "$EXE_PATH" | grep -qE "npm|node"; then
            IS_SUSPICIOUS=true
            REASONS+=("FAKE_BINARY: $EXE_PATH (Real: $REAL_NODE_PATH)")
        fi
    fi
    
    # Pattern 7: npm/node process NOT from Momentum_EMR directory
    if echo "$FULL_CMD" | grep -qE "npm|node"; then
        if [[ "$CWD" != *"Momentum_EMR"* ]]; then
            IS_SUSPICIOUS=true
            REASONS+=("WRONG_DIRECTORY: $CWD")
        fi
    fi
    
    # Pattern 8: Suspicious command line patterns
    if echo "$CMDLINE" | grep -qE "xmrig|cryptonight|stratum|pool\."; then
        IS_SUSPICIOUS=true
        REASONS+=("CRYPTO_MINER")
    fi
    
    if [[ "$IS_SUSPICIOUS" == "true" ]]; then
        MALICIOUS_PIDS+=("$pid")
        ((MALICIOUS_COUNT++))
        REASON_STR=$(IFS=', '; echo "${REASONS[*]}")
        log "${RED}✗ MALICIOUS - PID: $pid | CPU: ${CPU_USAGE}% | User: $USER${NC}"
        log "${RED}  Reasons: $REASON_STR${NC}"
        log "${RED}  Command: $FULL_CMD${NC}"
        log "${RED}  Path: $EXE_PATH${NC}"
        log_to_file "MALICIOUS: PID=$pid CPU=$CPU_USAGE% USER=$USER REASONS=[$REASON_STR] CMD=$FULL_CMD PATH=$EXE_PATH"
    fi
done

log "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
log "${BLUE}Found $MALICIOUS_COUNT malicious processes${NC}"
log "${MAGENTA}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# Step 4: Kill malicious processes
log "\n${YELLOW}[Step 4/6] Terminating malicious processes...${NC}"

if [[ $MALICIOUS_COUNT -eq 0 ]]; then
    log "${GREEN}✓ No malicious processes found!${NC}"
else
    for pid in "${MALICIOUS_PIDS[@]}"; do
        CMDLINE=$(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ' || echo "unknown")
        log "${YELLOW}Killing PID $pid: $CMDLINE${NC}"
        
        # Try SIGTERM first (graceful)
        if kill -15 "$pid" 2>/dev/null; then
            sleep 1
            # Check if still alive, then SIGKILL
            if ps -p "$pid" > /dev/null 2>&1; then
                log "${YELLOW}Process still alive, using SIGKILL...${NC}"
                kill -9 "$pid" 2>/dev/null || true
            fi
            log "${GREEN}✓ Killed PID $pid${NC}"
            log_to_file "KILLED: $pid"
        else
            log "${RED}✗ Failed to kill PID $pid (may already be dead)${NC}"
        fi
    done
fi

# Step 5: Deep clean malware binaries and hidden files
log "\n${YELLOW}[Step 5/7] Deep cleaning malware binaries...${NC}"

MALWARE_PATHS=(
    "/tmp/nodejs"
    "/tmp/npm"
    "/tmp/node"
    "/var/tmp/nodejs"
    "/var/tmp/npm"
    "/var/tmp/node"
    "/dev/shm/nodejs"
    "/dev/shm/npm"
)

CLEANED_COUNT=0
for malware_path in "${MALWARE_PATHS[@]}"; do
    if [[ -f "$malware_path" ]]; then
        log "${YELLOW}Removing: $malware_path${NC}"
        rm -f "$malware_path"
        log "${GREEN}✓ Removed $malware_path${NC}"
        log_to_file "REMOVED: $malware_path"
        ((CLEANED_COUNT++))
    fi
done

# Find and remove UPX packed binaries in temp locations
log "${YELLOW}Searching for UPX packed malware...${NC}"
UPX_FILES=$(find /tmp /var/tmp /dev/shm -type f -executable 2>/dev/null | xargs -r file 2>/dev/null | grep "UPX compressed" | cut -d: -f1 || echo "")
for upx_file in $UPX_FILES; do
    log "${YELLOW}Removing UPX packed file: $upx_file${NC}"
    rm -f "$upx_file"
    log "${GREEN}✓ Removed UPX malware: $upx_file${NC}"
    log_to_file "REMOVED_UPX: $upx_file"
    ((CLEANED_COUNT++))
done

# Clean suspicious executables from temp directories
SUSPICIOUS_EXES=$(find /tmp /var/tmp -type f -name "*node*" -o -name "*npm*" 2>/dev/null || echo "")
for sus_exe in $SUSPICIOUS_EXES; do
    if [[ ! "$sus_exe" =~ ".log" && ! "$sus_exe" =~ ".txt" ]]; then
        log "${YELLOW}Removing suspicious executable: $sus_exe${NC}"
        rm -f "$sus_exe"
        ((CLEANED_COUNT++))
    fi
done

log "${GREEN}✓ Cleaned $CLEANED_COUNT malware files${NC}"

# Step 6: Clean malicious cron jobs
log "\n${YELLOW}[Step 6/7] Checking for malicious cron jobs...${NC}"

CRON_BACKUP="/tmp/crontab_backup_$(date +%s).txt"
crontab -l > "$CRON_BACKUP" 2>/dev/null || true

SUSPICIOUS_CRONS=$(crontab -l 2>/dev/null | grep -E "/tmp/|wget.*tmp|curl.*tmp|nodejs|xmrig" || echo "")
if [[ -n "$SUSPICIOUS_CRONS" ]]; then
    log "${RED}Found suspicious cron jobs:${NC}"
    log "$SUSPICIOUS_CRONS"
    log "${YELLOW}Removing suspicious cron entries...${NC}"
    crontab -l 2>/dev/null | grep -vE "/tmp/|wget.*tmp|curl.*tmp|nodejs|xmrig" | crontab -
    log "${GREEN}✓ Cleaned cron jobs (backup: $CRON_BACKUP)${NC}"
    log_to_file "CRON_CLEANED"
else
    log "${GREEN}✓ No suspicious cron jobs found${NC}"
fi

# Step 7: Restart Momentum EMR properly
log "\n${YELLOW}[Step 7/7] Ensuring Momentum EMR is running correctly...${NC}"

EMR_STATUS=$(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="momentum-emr") | .pm2_env.status' || echo "")

if [[ "$EMR_STATUS" != "online" ]]; then
    log "${YELLOW}Momentum EMR is not online. Starting fresh...${NC}"
    
    # Kill any process on port 3000
    PORT_3000_PID=$(sudo lsof -ti:3000 2>/dev/null || echo "")
    if [[ -n "$PORT_3000_PID" ]]; then
        log "${YELLOW}Killing process on port 3000: $PORT_3000_PID${NC}"
        sudo kill -9 $PORT_3000_PID 2>/dev/null || true
    fi
    
    # Delete and restart
    pm2 delete momentum-emr 2>/dev/null || true
    cd "$APP_DIR/apps/web" || cd ~/Momentum_EMR/apps/web
    pm2 start npm --name momentum-emr -- start
    pm2 save
    log "${GREEN}✓ Momentum EMR started${NC}"
    log_to_file "EMR STARTED"
    
    # Wait and check
    sleep 3
    EMR_NEW_STATUS=$(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="momentum-emr") | .pm2_env.status' || echo "")
    if [[ "$EMR_NEW_STATUS" == "online" ]]; then
        log "${GREEN}✓ Momentum EMR is now online!${NC}"
    else
        log "${RED}✗ Failed to start Momentum EMR. Check logs: pm2 logs momentum-emr${NC}"
    fi
else
    log "${GREEN}✓ Momentum EMR is already online${NC}"
fi

# Final status
echo ""
echo "========================================="
log "${GREEN}Cleanup Complete!${NC}"
echo "========================================="
log "\n${BLUE}Summary:${NC}"
log "  Protected processes: ${#LEGITIMATE_PIDS[@]}"
log "  Malicious processes killed: $MALICIOUS_COUNT"
log "  Momentum EMR status: $(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="momentum-emr") | .pm2_env.status' || echo "unknown")"
log "\n${BLUE}Next steps:${NC}"
log "  1. Check website: http://your-domain.com"
log "  2. Monitor CPU: ${YELLOW}htop${NC} or ${YELLOW}pm2 monit${NC}"
log "  3. View logs: ${YELLOW}tail -f $LOG_FILE${NC}"
log "  4. PM2 status: ${YELLOW}pm2 status${NC}"
echo ""
log "${YELLOW}Log saved to: $LOG_FILE${NC}"
