#!/bin/bash
###############################################################################
# Kill Malware & Protect Momentum EMR
# This script eliminates malicious npm/node processes while keeping the 
# legitimate Momentum EMR application running.
###############################################################################

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

LOG_FILE="/var/log/malware-cleanup.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Logging function
log() {
    echo -e "${1}" | tee -a "$LOG_FILE"
}

log_to_file() {
    echo "[$TIMESTAMP] $1" >> "$LOG_FILE"
}

echo "========================================="
log "${BLUE}Malware Cleanup & App Protection${NC}"
log "${BLUE}Started: $TIMESTAMP${NC}"
echo "========================================="

# Step 1: Get legitimate PM2 process info
log "\n${YELLOW}[Step 1/6] Identifying legitimate Momentum EMR processes...${NC}"

# Get PM2 app PIDs (the Node.js process running the actual app)
LEGITIMATE_PIDS=()

# Get PM2 daemon PID
PM2_DAEMON_PID=$(pgrep -f "PM2 v" | head -1 || echo "")
if [[ -n "$PM2_DAEMON_PID" ]]; then
    LEGITIMATE_PIDS+=("$PM2_DAEMON_PID")
    log "${GREEN}✓ PM2 Daemon PID: $PM2_DAEMON_PID${NC}"
    log_to_file "PM2 Daemon: $PM2_DAEMON_PID"
fi

# Get momentum-emr app PID from PM2
EMR_APP_PID=$(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="momentum-emr") | .pid' || echo "")
if [[ -n "$EMR_APP_PID" && "$EMR_APP_PID" != "0" ]]; then
    LEGITIMATE_PIDS+=("$EMR_APP_PID")
    log "${GREEN}✓ Momentum EMR App PID: $EMR_APP_PID${NC}"
    log_to_file "EMR App: $EMR_APP_PID"
fi

# Get all child processes of PM2
if [[ -n "$PM2_DAEMON_PID" ]]; then
    PM2_CHILDREN=$(pgrep -P "$PM2_DAEMON_PID" || echo "")
    for child_pid in $PM2_CHILDREN; do
        LEGITIMATE_PIDS+=("$child_pid")
        log "${GREEN}✓ PM2 Child Process: $child_pid${NC}"
        log_to_file "PM2 Child: $child_pid"
    done
fi

# Get pnpm processes (legitimate package manager)
PNPM_PIDS=$(pgrep -f "pnpm" || echo "")
for pnpm_pid in $PNPM_PIDS; do
    LEGITIMATE_PIDS+=("$pnpm_pid")
    log "${GREEN}✓ PNPM Process: $pnpm_pid${NC}"
    log_to_file "PNPM: $pnpm_pid"
done

log "${BLUE}Total legitimate processes protected: ${#LEGITIMATE_PIDS[@]}${NC}"

# Step 2: Find all node/npm processes
log "\n${YELLOW}[Step 2/6] Scanning for all node/npm processes...${NC}"

ALL_NODE_PIDS=$(pgrep -f "node|npm" || echo "")
TOTAL_NODE_PROCESSES=$(echo "$ALL_NODE_PIDS" | wc -w)
log "${BLUE}Found $TOTAL_NODE_PROCESSES node/npm processes${NC}"

# Step 3: Identify suspicious processes
log "\n${YELLOW}[Step 3/6] Identifying malicious processes...${NC}"

MALICIOUS_PIDS=()
MALICIOUS_COUNT=0

for pid in $ALL_NODE_PIDS; do
    # Skip if PID is in legitimate list
    if [[ " ${LEGITIMATE_PIDS[@]} " =~ " ${pid} " ]]; then
        continue
    fi
    
    # Get process details
    CMDLINE=$(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ' || echo "")
    CPU_USAGE=$(ps -p $pid -o %cpu --no-headers 2>/dev/null || echo "0")
    MEM_USAGE=$(ps -p $pid -o %mem --no-headers 2>/dev/null || echo "0")
    
    # Check for suspicious patterns
    IS_SUSPICIOUS=false
    REASON=""
    
    # Pattern 1: High CPU usage (>30%)
    if (( $(echo "$CPU_USAGE > 30" | bc -l 2>/dev/null || echo 0) )); then
        IS_SUSPICIOUS=true
        REASON="High CPU: ${CPU_USAGE}%"
    fi
    
    # Pattern 2: npm/node with suspicious names or locations
    if echo "$CMDLINE" | grep -qE "/tmp/|npm start 1G|nodejs.*tmp"; then
        IS_SUSPICIOUS=true
        REASON="Suspicious location/name: $CMDLINE"
    fi
    
    # Pattern 3: UPX packed binary
    if file /proc/$pid/exe 2>/dev/null | grep -q "UPX compressed"; then
        IS_SUSPICIOUS=true
        REASON="UPX packed binary"
    fi
    
    # Pattern 4: Running from /tmp or /var/tmp
    EXE_PATH=$(readlink -f /proc/$pid/exe 2>/dev/null || echo "")
    if echo "$EXE_PATH" | grep -qE "^/tmp/|^/var/tmp/"; then
        IS_SUSPICIOUS=true
        REASON="Running from temp directory: $EXE_PATH"
    fi
    
    if [[ "$IS_SUSPICIOUS" == "true" ]]; then
        MALICIOUS_PIDS+=("$pid")
        ((MALICIOUS_COUNT++))
        log "${RED}✗ MALICIOUS - PID: $pid | CPU: ${CPU_USAGE}% | Reason: $REASON${NC}"
        log_to_file "MALICIOUS: PID=$pid CPU=$CPU_USAGE% REASON=$REASON CMD=$CMDLINE"
    fi
done

log "${BLUE}Found $MALICIOUS_COUNT malicious processes${NC}"

# Step 4: Kill malicious processes
log "\n${YELLOW}[Step 4/6] Terminating malicious processes...${NC}"

if [[ $MALICIOUS_COUNT -eq 0 ]]; then
    log "${GREEN}✓ No malicious processes found!${NC}"
else
    for pid in "${MALICIOUS_PIDS[@]}"; do
        CMDLINE=$(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ' || echo "unknown")
        log "${YELLOW}Killing PID $pid: $CMDLINE${NC}"
        
        # Try SIGTERM first (graceful)
        if kill -15 "$pid" 2>/dev/null; then
            sleep 1
            # Check if still alive, then SIGKILL
            if ps -p "$pid" > /dev/null 2>&1; then
                log "${YELLOW}Process still alive, using SIGKILL...${NC}"
                kill -9 "$pid" 2>/dev/null || true
            fi
            log "${GREEN}✓ Killed PID $pid${NC}"
            log_to_file "KILLED: $pid"
        else
            log "${RED}✗ Failed to kill PID $pid (may already be dead)${NC}"
        fi
    done
fi

# Step 5: Remove malware binaries
log "\n${YELLOW}[Step 5/6] Cleaning malware binaries...${NC}"

MALWARE_PATHS=(
    "/tmp/nodejs"
    "/tmp/npm"
    "/tmp/node"
    "/var/tmp/nodejs"
    "/var/tmp/npm"
    "/var/tmp/node"
)

for malware_path in "${MALWARE_PATHS[@]}"; do
    if [[ -f "$malware_path" ]]; then
        log "${YELLOW}Removing: $malware_path${NC}"
        rm -f "$malware_path"
        log "${GREEN}✓ Removed $malware_path${NC}"
        log_to_file "REMOVED: $malware_path"
    fi
done

# Step 6: Restart Momentum EMR if needed
log "\n${YELLOW}[Step 6/6] Ensuring Momentum EMR is running...${NC}"

EMR_STATUS=$(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="momentum-emr") | .pm2_env.status' || echo "")

if [[ "$EMR_STATUS" != "online" ]]; then
    log "${YELLOW}Momentum EMR is not running. Restarting...${NC}"
    cd /home/momentum/Momentum/EMR || cd ~/Momentum/EMR
    pm2 restart momentum-emr 2>/dev/null || pm2 start npm --name momentum-emr -- start
    log "${GREEN}✓ Momentum EMR restarted${NC}"
    log_to_file "EMR RESTARTED"
else
    log "${GREEN}✓ Momentum EMR is online${NC}"
fi

# Final status
echo ""
echo "========================================="
log "${GREEN}Cleanup Complete!${NC}"
echo "========================================="
log "\n${BLUE}Summary:${NC}"
log "  Protected processes: ${#LEGITIMATE_PIDS[@]}"
log "  Malicious processes killed: $MALICIOUS_COUNT"
log "  Momentum EMR status: $(pm2 jlist 2>/dev/null | jq -r '.[] | select(.name=="momentum-emr") | .pm2_env.status' || echo "unknown")"
log "\n${BLUE}Next steps:${NC}"
log "  1. Check website: http://your-domain.com"
log "  2. Monitor CPU: ${YELLOW}htop${NC} or ${YELLOW}pm2 monit${NC}"
log "  3. View logs: ${YELLOW}tail -f $LOG_FILE${NC}"
log "  4. PM2 status: ${YELLOW}pm2 status${NC}"
echo ""
log "${YELLOW}Log saved to: $LOG_FILE${NC}"
